---
title: "Imputation of missing data"
author: "Sophie Meakin"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
date: "`r format(Sys.Date(), '%d %B %Y')`"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  include = TRUE, cache = FALSE, echo = FALSE,
  tidy = TRUE,
  warning = FALSE, message = FALSE, error = FALSE,
  fig.show = 'hold',
  fig.width = 12,
  fig.height = 9, 
  dpi = 300,
  dev = 'png'
)
```

```{r}
library(here)
library(magrittr)
library(dplyr)
library(tidyr)
library(tibble)
library(gtsummary)
library(ggplot2)
library(patchwork)
```

```{r}
source(here("R/set_paths.R"))
paths <- set_paths()
path_data_imp <- here("outputs", "0_data_imp")
```

```{r}
data_raw <- readRDS(file = here("outputs", "0_data_imp", "raw_unmatched_alleligible.rds")) %>%
  mutate(data = "Observed") %>%
  mutate(
    evd_status = factor(evd_status, ordered = FALSE)
  )
data_imp_i0 <- readRDS(file = here(path_data_imp, "imp_m50_unmatched_alleligible__i0.rds"))
data_imp_i1 <- readRDS(file = here(path_data_imp, "imp_m50_unmatched_alleligible__i1.rds"))
data_imp_i2 <- readRDS(file = here(path_data_imp, "imp_m50_unmatched_alleligible__i2.rds"))
data_imp_i3 <- readRDS(file = here(path_data_imp, "imp_m50_unmatched_alleligible__i3.rds"))
```

# Observed data

## Table: Vaccination status
```{r}
data_raw %>%
  mutate(
    vacc_status_delay = case_when(
      !vacc ~ "Unvaccinated",
      vacc & !is.na(delay_vacc_onset) ~ "Vaccinated, delay known",
      vacc & is.na(delay_vacc_onset) ~ "Vaccinated, delay unknown",
    ),
    vacc_status_delay = factor(
      vacc_status_delay, c("Unvaccinated", "Vaccinated, delay known", "Vaccinated, delay unknown"),
      ordered = TRUE
    )
  ) %>%
  select(
    evd_status,
    `Vaccianted` = vacc, `Vaccination status` = vacc_status_delay
  ) %>%
  tbl_summary(by = evd_status) %>%
  add_overall()
```

## Table: Demographics of individuals with missing vs. known delays
```{r}
evd_pos <- data_raw %>%
  filter(evd_status == "EVD-pos") %>%
  filter(vacc) %>%
  mutate(
    is_delay_missing = ifelse(is.na(delay_vacc_onset), "Delay missing", "Delay known"),
    is_delay_missing = factor(is_delay_missing, c("Delay missing", "Delay known"))
  ) %>%
  mutate(
    month_onset = factor(
      month_onset,
      format(seq.Date(
        from = as.Date("2018-08-01"),
        to = as.Date("2019-11-01"),
        by = "month"), format = "%Y-%m"),
      ordered = TRUE
    )
  ) %>%
  select(
    is_delay_missing,
    sex, age_gp, adm2_name__res_gp, month_onset
  ) %>%
  tbl_summary(
    by = is_delay_missing,
    missing_text = "(Missing)",
    label = list(
      sex ~ "Sex", age_gp ~ "Age (years)",
      adm2_name__res_gp ~ "Health zone",
      month_onset ~ "Month symptom onset"
    )
  )
evd_neg <- data_raw %>%
  filter(evd_status == "EVD-neg") %>%
  filter(vacc) %>%
  mutate(
    is_delay_missing = ifelse(is.na(delay_vacc_onset), "Delay missing", "Delay known"),
    is_delay_missing = factor(is_delay_missing, c("Delay missing", "Delay known"))
  ) %>%
  select(
    is_delay_missing,
    sex, age_gp, adm2_name__res_gp, month_onset
  ) %>%
  tbl_summary(
    by = is_delay_missing,
    missing_text = "(Missing)",
        label = list(
      sex ~ "Sex", age_gp ~ "Age (years)",
      adm2_name__res_gp ~ "Health zone",
      month_onset ~ "Month symptom onset"
    )
  )

tbl_merge(
  tbls = list(evd_pos, evd_neg),
  tab_spanner = c("**EVD-positive**", "**EVD-negative**")
)
```

## Observed vaccination-onset delay

### By EVD status
```{r}
data_raw %>%
  filter(vacc) %>%
  group_by(evd_status) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10, na.rm = TRUE)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
data_raw %>%
  filter(delay_vacc_onset >= 0) %>%
  ggplot(aes(x = delay_vacc_onset)) +
  geom_line(aes(col = evd_status), stat = "density", lwd = 0.6) +
  scale_x_continuous(limits = c(0, 85), breaks = seq(0, 84, 28)) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "EVD status") +
  theme_bw() +
  theme(legend.position = "top")
```

### By contact status
```{r}
data_raw %>%
  filter(vacc) %>%
  group_by(contact_status = (contact_evd_case == "Yes")) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10, na.rm = TRUE)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
data_raw %>%
  filter(delay_vacc_onset >= 0) %>%
  mutate(
    contact_status = (contact_evd_case == "Yes"),
    contact_status = factor(contact_status, c(TRUE, FALSE))
    ) %>%
  ggplot(aes(x = delay_vacc_onset)) +
  geom_line(aes(lty = contact_status), stat = "density", lwd = 0.6) +
  scale_x_continuous(limits = c(0, 85), breaks = seq(0, 84, 28)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       lty = "Contact status") +
  theme_bw() +
  theme(legend.position = "top")
```

### By EVD status and contact status
```{r}
data_raw %>%
  filter(vacc) %>%
  group_by(evd_status, contact_status = (contact_evd_case == "Yes")) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10, na.rm = TRUE)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
data_raw %>%
  filter(delay_vacc_onset >= 0) %>%
  mutate(
    contact_status = (contact_evd_case == "Yes"),
    contact_status = factor(contact_status, c(TRUE, FALSE))
    ) %>%
  ggplot(aes(x = delay_vacc_onset)) +
  geom_line(aes(col = evd_status, lty = contact_status), stat = "density", lwd = 0.6) +
  scale_x_continuous(limits = c(0, 85), breaks = seq(0, 84, 28)) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "EVD status", lty = "Contact status") +
  theme_bw() +
  theme(legend.position = "top")
```

### By EVD status and sex / age group
```{r, eval = FALSE}
data_raw %>%
  filter(vacc) %>%
  filter(!is.na(sex)) %>%
  group_by(evd_status, sex) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10, na.rm = TRUE)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r, eval = FALSE}
data_raw %>%
  filter(vacc) %>%
  filter(!is.na(age_gp)) %>%
  group_by(evd_status, age_gp) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10, na.rm = TRUE)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```



# Imputed vs. observed data

## Summary statistics

```{r}
imp_ids <- data_raw %>%
  filter(vacc, is.na(delay_vacc_onset)) %>%
  pull(patient_id_unique)
```

```{r}
impobs_compare <- bind_rows(
  data_raw %>% mutate(data = "Observed"),
  data_imp_i0$mice_out_format %>% mutate(data = "Imputed (0)") %>% filter(patient_id_unique %in% imp_ids),
  data_imp_i1$mice_out_format %>% mutate(data = "Imputed (1)") %>% filter(patient_id_unique %in% imp_ids),
  data_imp_i2$mice_out_format %>% mutate(data = "Imputed (2)") %>% filter(patient_id_unique %in% imp_ids),
  # data_imp_i3$mice_out_format %>% mutate(data = "Imputed (3)") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed (0)", "Imputed (1)", "Imputed (2)", "Imputed (3)"), ordered = TRUE)) %>%
  filter(delay_vacc_onset >= 0) %>%
  filter(!(vacc & is.na(delay_vacc_onset)))
```

### By EVD status
```{r}
impobs_compare %>%
  group_by(evd_status, data) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

# All imputations combined
impobs_compare %>%
  group_by(evd_status, data) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    .groups = "drop"
  ) %>%
  mutate(
    p_delay10d_lwr = binom::binom.confint(x = n_delay10d, n = n, method = "exact")$lower,
    p_delay10d_upr = binom::binom.confint(x = n_delay10d, n = n, method = "exact")$upper
  ) %>%
  ggplot(aes(x = data, y = p_delay10d)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = p_delay10d_lwr, ymax = p_delay10d_upr), width = 0.05) +
  facet_wrap(~ evd_status, ncol = 1, scales = "free_y") +
  labs(x = NULL, y = "Proportion vaccinated at least 10 days before symptom onset") +
  theme_bw()

# Distribution over all imputations
impobs_compare %>%
  group_by(evd_status, data, .imp) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = data, y = p_delay10d)) +
  geom_violin(aes(fill = evd_status), col = NA, alpha = 0.5, position = position_dodge(width = 1)) +
  geom_boxplot(aes(col = evd_status), width = 0.1, position = position_dodge(width = 1)) +
  facet_wrap(~ evd_status, ncol = 1, scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  labs(x = NULL, y = "Proportion vaccinated at least 10 days before symptom onset") +
  theme_bw() +
  theme(legend.position = "none")
```

### By EVD status (contacts)
```{r}
impobs_compare %>%
  filter(contact_evd_case == "Yes") %>%
  group_by(evd_status, data) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

# All imputations combined
impobs_compare %>%
  filter(contact_evd_case == "Yes") %>%
  group_by(evd_status, data) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    .groups = "drop"
  ) %>%
  mutate(
    p_delay10d_lwr = binom::binom.confint(x = n_delay10d, n = n, method = "exact")$lower,
    p_delay10d_upr = binom::binom.confint(x = n_delay10d, n = n, method = "exact")$upper
  ) %>%
  ggplot(aes(x = data, y = p_delay10d)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = p_delay10d_lwr, ymax = p_delay10d_upr), width = 0.05) +
  facet_wrap(~ evd_status, ncol = 1, scales = "free_y") +
  scale_y_continuous(breaks = seq(0, 1, 0.05)) +
  labs(x = NULL, y = "Proportion vaccinated at least 10 days before symptom onset") +
  theme_bw()

# Distribution over all imputations
impobs_compare %>%
  filter(contact_evd_case == "Yes") %>%
  group_by(evd_status, data, .imp) %>%
  summarise(
    n = n(),
    n_delay10d = sum(delay_vacc_onset >= 10),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = data, y = p_delay10d)) +
  geom_violin(aes(fill = evd_status), col = NA, alpha = 0.5, position = position_dodge(width = 1)) +
  geom_boxplot(aes(col = evd_status), width = 0.1, position = position_dodge(width = 1)) +
  facet_wrap(~ evd_status, ncol = 1, scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  labs(x = NULL, y = "Proportion vaccinated at least 10 days before symptom onset") +
  theme_bw() +
  theme(legend.position = "none")
```

### By EVD status and sex / age group
```{r}
# Sex
impobs_compare %>%
  filter(!is.na(sex)) %>%
  group_by(evd_status, sex, data) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
# Age group
impobs_compare %>%
  filter(!is.na(age_gp)) %>%
  group_by(evd_status, age_gp, data) %>%
  summarise(
    n = n(),
    p_delay10d = sum(delay_vacc_onset >= 10)/n(),
    delay_q50 = quantile(delay_vacc_onset, 0.5, na.rm = TRUE),
    delay_q975 = quantile(delay_vacc_onset, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```


## Distribution of vaccination-onset delays

### Imputation (0)
```{r}
# Histogram, overall
bind_rows(
  data_raw,
  data_imp_i0$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  annotate(geom = "text", x = 11, y = 0.0625, label = "Delay = 10 days", hjust = 0) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 84, 14)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")

# Histogram, by EVD status
bind_rows(
  data_raw,
  data_imp_i0$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  filter(!is.na(sex), !is.na(age_gp)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  facet_grid(evd_status ~ .) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 560, 28)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")
```

### Imputation (1)
```{r}
# Histogram, overall
bind_rows(
  data_raw,
  data_imp_i1$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  annotate(geom = "text", x = 11, y = 0.0625, label = "Delay = 10 days", hjust = 0) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 84, 28)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")

# Histogram, by EVD status
bind_rows(
  data_raw,
  data_imp_i1$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  filter(!is.na(sex), !is.na(age_gp)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  facet_grid(evd_status ~ .) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 560, 28)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")
```

### Imputation (2)
```{r}
# Histogram, overall
g_diag_delays <- bind_rows(
  data_raw,
  data_imp_i2$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  annotate(geom = "text", x = 11, y = 0.0625, label = "Delay = 10 days", hjust = 0) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 84, 14)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       title = "A",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")
g_diag_delays

# Histogram, by EVD status
g_diag_delays_evd <- bind_rows(
  data_raw,
  data_imp_i2$mice_out_format %>% mutate(data = "Imputed") %>% filter(patient_id_unique %in% imp_ids)
) %>%
  mutate(data = factor(data, c("Observed", "Imputed"), ordered = TRUE)) %>%
  filter(!is.na(sex), !is.na(age_gp)) %>%
  ggplot(aes(x = delay_vacc_onset, y = after_stat(density))) +
  geom_histogram(aes(col = data, fill = data, alpha = data), binwidth = 1, position = position_identity()) +
  geom_vline(xintercept = 10, lty = 2) +
  facet_grid(evd_status ~ .) +
  scale_x_continuous(limits = c(-1, 85), breaks = seq(0, 84, 14)) +
  scale_color_manual(values = c("Observed" = "grey70", "Imputed" = "grey10")) +
  scale_fill_manual(values = c("Observed" = "grey70", "Imputed" = "white")) +
  scale_alpha_manual(values = c("Observed" = 1, "Imputed" = 0)) +
  labs(x = "Vaccination-onset delay (days)", y = "density",
       title = "B",
       col = "Data", fill = "Data", alpha = "Data") +
  theme_bw() +
  theme(legend.position = "top")
g_diag_delays_evd
```

### Figure: Diagnostics

```{r}
guide_area() / g_diag_delays / g_diag_delays_evd + plot_layout(guides = "collect", heights = c(1, 7, 7))
```



# Effect on matched data

```{r}
mat_i0 <- readRDS(here("outputs", "1_data_mat", "imp_m50_matched_n10_10d_a1__imp_i0.rds"))
mat_i1 <- readRDS(here("outputs", "1_data_mat", "imp_m50_matched_n10_10d_a1__imp_i1.rds"))
mat_i2 <- readRDS(here("outputs", "1_data_mat", "imp_m50_matched_n10_10d_a1.rds"))
```

```{r}
mat_i0$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(evd_status, vacc_status) %>%
  summarise(
    n_min = min(n),
    n_median = median(n),
    n_max = max(n)
  )
mat_i1$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(evd_status, vacc_status) %>%
  summarise(
    n_min = min(n),
    n_median = median(n),
    n_max = max(n)
  )
mat_i2$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(evd_status, vacc_status) %>%
  summarise(
    n_min = min(n),
    n_median = median(n),
    n_max = max(n)
  )
```



# Effect on VE

## Within imputation

```{r}
model_10d_a1 <- readRDS(file = here("outputs", "3_model_samples", "imp_10d_a1.rds"))
```

```{r}
g_imp_a <- model_10d_a1 %>%
  mutate(
    iter = as.numeric(iter),
    imp = 1 + floor((iter - 1)/10)
  ) %>%
  ggplot(aes(x = ve)) +
  geom_line(aes(group = imp), stat = "density", col = "grey70", alpha = 0.25) +
  # geom_density(col = "tomato3", lwd = 1) +
  scale_x_continuous(limits = c(40, 100), breaks = seq(0, 100, 20)) +
  scale_y_continuous(breaks = seq(0, 0.1, 0.05)) +
  labs(subtitle = "A",
       x = "Vaccine effectiveness (%)", y = "density") +
  theme_bw()

g_imp_b <- summarise_ve(
  model_10d_a1 %>% mutate(imp = 1 + floor((as.numeric(iter) - 1)/10)),
  imp
) %>%
  ggplot(aes(y = imp, x = ve_50)) +
  geom_point(size = 1.5, col = "grey50") +
  geom_errorbar(aes(xmin = ve_025, xmax = ve_975), col = "grey50", width = 0, lwd = 0.6) +
  scale_x_continuous(limits = c(40, 100), breaks = seq(0, 100, 20)) +
  scale_y_continuous(breaks = seq(1, 50, 2)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 12, name = "Set3")[c(1, 12, 3:9, 11)]) +
  labs(subtitle = "B",
       x = "Vaccine effectiveness (%)", y = "imputation") +
  theme_bw() +
  theme(axis.text.y = element_blank())

g_imp_a / g_imp_b + plot_layout(heights = c(1, 2))
```

## Between different imputation methods

```{r}
adj_a1__i0 <- readRDS(file = here("outputs", "3_model_samples", "_archive", "imp_10d_a1.rds"))
```

```{r}
# Compare original method (0) and "better" method (2)
bind_rows(
  adj_a1 %>% mutate(method_imp = "Imputation method 2"),
  adj_a1__i0 %>% mutate(method_imp = "Imputation method 0")
) %>%
  group_by(method_imp) %>%
  summarise(
    ve_q50 = median(ve),
    ve_q025 = quantile(ve, 0.025),
    ve_q975 = quantile(ve, 0.975),
  )
```







