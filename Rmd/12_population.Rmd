---
title: "Eligibility and study population demographics"
author: "Sophie Meakin"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
date: "`r format(Sys.Date(), '%d %B %Y')`"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  include = TRUE, cache = FALSE, echo = FALSE,
  tidy = TRUE,
  warning = FALSE, message = FALSE, error = FALSE,
  fig.show = 'hold',
  fig.width = 12,
  fig.height = 9, 
  dpi = 300,
  dev = 'png'
)
```

```{r}
library(here)
library(magrittr)
library(dplyr)
library(tidyr)
library(tibble)
library(flextable)
library(gtsummary)
library(ggplot2)
library(patchwork)
```

```{r}
source(here("R/set_paths.R"))
paths <- set_paths()
path_matched_data <- here("outputs", "matched_data")

source(here("R/wrangle_etc.R"))
```

```{r}
# Raw ETC data
etc_raw <- readr::read_csv(
  file = paths$file_data_etc,
  progress = FALSE
)

# All eligible, unmatched
etc_elig_raw <- etc_1step()$etc_format_brms
etc_elig_imp <- readRDS(file = here("outputs", "0_data_imp", "imp_m50_unmatched_alleligible__i2.rds"))

# Vaccination-onset delay 10+ days
etc_10d_imp <- readRDS(file = here("outputs", "1_data_mat", "imp_m50_matched_n10_10d_a1.rds"))
# Vaccination-onset delay 3-9 days
etc_3d_imp <- readRDS(file = here("outputs", "1_data_mat", "imp_m50_matched_n10_3d_a1.rds"))
```

```{r}
# Get values for eligibility flow chart
## Clean ETC
etc_all <- assemble_etc(etc_raw)$out
## Filter for eligible population
etc_all_eligible <- filter_eligible(etc_all)
```


# Elderly

```{r}
tmp <- etc_all |> 
  mutate(
    age_gp_old = case_when(
      age_years < 50 ~ "0 - 49",
      age_years < 60 ~ "50 - 59",
      age_years < 70 ~ "60 - 69",
      age_years < 80 ~ "70 - 79",
      age_years >= 80 ~ "80+",
    ),
    age_50 = age_years >= 50,
    age_60 = age_years >= 60,
    vacc = case_when(
      vacc ~ "Vaccinated",
      !vacc ~ "Unvaccinated",
      is.na(vacc) ~ "Unknown"
    ),
    vacc = ordered(vacc, c("Vaccinated", "Unvaccinated", "Unknown"))
  )
# All
tmp |> 
  select(
    `Age ≥50 years` = age_50,
    `Age ≥60 years` = age_60,
    `Age group (years)` = age_gp_old,
    evd_status, Vaccinated = vacc
  ) |> 
  tbl_strata(
    strata = evd_status,
    ~.x %>%
      tbl_summary(
        by = Vaccinated
      ) %>%
      add_overall() %>%
      modify_header(all_stat_cols() ~ "**{level}**")
  )

# Outcome
tmp |>
  filter(evd_status == "EVD-pos", !is.na(outcome)) |> 
  select(
    `Age ≥50 years` = age_50,
    `Age ≥60 years` = age_60,
    `Age group (years)` = age_gp_old,
    outcome, Vaccinated = vacc
  ) |> 
  tbl_strata(
    strata = outcome,
    ~.x %>%
      tbl_summary(
        by = Vaccinated
      ) %>%
      add_overall() %>%
      modify_header(all_stat_cols() ~ "**{level}**")
  )
```



# Eligibility

```{r}
# Print eligibility table
etc_all_eligible$etc_criteria_sum %>%
  flextable() %>%
  set_table_properties(layout = "autofit") %>%
  flextable::theme_vanilla()
```

```{r}
etc_all |> 
  left_join(etc_all_eligible$etc_criteria, by = "patient_id_unique") |> 
  filter(
    ex_any == "Y",
    # ex_vaccn == "N"
  ) |> 
  filter(!patient_id_unique %in% etc_all_eligible$etc_eligible$patient_id_unique) |>
  count(evd_status)
```

## By EVD status

```{r}
anti_join(etc_all, etc_all_eligible$etc_eligible, by = "patient_id_unique") |> 
  count(evd_status)
```

# All eligible population {.tabset}

All eligible:

-   No imputation
-   No matching
-   No exposure definition applied
-   No restriction on vaccination-onset delay

## Demographics

### Table
```{r}
t_eligible_demog <- etc_elig_raw %>%
  select(
    evd_status,
    Sex = sex,
    `Age (years)` = age_gp,
    `Health zone` = adm2_name__res_gp,
    `Month symptom onset` = month_onset,
    `Vaccination status` = vacc_status
    ) %>%
  tbl_summary(by = evd_status, missing_text = "(Missing)")
t_eligible_demog

# Save table
gt::gtsave(as_gt(t_eligible_demog), file = here("outputs", "tables", "tb_demog_alleligible.docx"))
```

```{r}
# Details

## Contact with an EVD case
etc_elig_raw %>%
  filter(contact_evd_case == "Yes") %>%
  mutate(vacc_status = factor(
    vacc_status,
    setdiff(levels(etc_elig_raw$vacc_status), "Vaccinated (negative)"),
    ordered = TRUE
  )) %>%
  select(
    evd_status,
    Sex = sex,
    `Age (years)` = age_gp,
    `Health zone` = adm2_name__res_gp,
    `Month symptom onset` = month_onset,
    `Vaccination status` = vacc_status
    ) %>%
  tbl_summary(by = evd_status, missing_text = "(Missing)")

## Number of health zones, by EVD infection status
etc_elig_raw %>%
  count(evd_status, adm1_name__res, adm2_name__res) %>%
  group_by(evd_status) %>%
  mutate(p = 100*n/sum(n)) %>%
  group_by(evd_status, adm1_name__res) %>%
  mutate(
    n_adm1 = sum(n),
    p_adm1 = sum(p)
    )
```


### Figure
```{r}
# Sex
g_pop_elig_sex <- etc_elig_raw %>%
  filter(!is.na(sex)) %>%
  count(evd_status, sex) %>%
  group_by(evd_status) %>%
  mutate(p = n / sum(n),
         .groups = "drop") %>%
  ggplot(aes(x = sex, y = 100*p, fill = evd_status)) +
  geom_col(position = position_dodge(), alpha = 0.9) +
  scale_fill_brewer(palette = "Set1") +
    labs(x = "Sex",
       y = "%",
       subtitle = "A",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "top")

# Age group
g_pop_elig_age <- etc_elig_raw %>%
  filter(!is.na(age_gp)) %>%
  count(evd_status, age_gp) %>%
  group_by(evd_status) %>%
  mutate(p = n / sum(n),
         .groups = "drop") %>%
  ggplot(aes(x = age_gp, y = 100*p, fill = evd_status)) +
  geom_col(position = position_dodge(), alpha = 0.9) +
  scale_fill_brewer(palette = "Set1") +
    labs(x = "Age group (years)",
       y = "%",
       subtitle = "B",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "top")

# Health zone
g_pop_elig_hz <- etc_elig_raw %>%
  count(evd_status, adm2_name__res_gp) %>%
  group_by(evd_status) %>%
  mutate(p = n / sum(n),
         .groups = "drop") %>%
  ggplot(aes(x = adm2_name__res_gp, y = 100*p, fill = evd_status)) +
  geom_col(position = position_dodge(), alpha = 0.9) +
  scale_fill_brewer(palette = "Set1") +
    labs(x = "Health zone",
       y = "%",
       subtitle = "C",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "top")

# Month of symptom onset
g_pop_elig_month <- etc_elig_raw %>%
  filter(!is.na(age_gp)) %>%
  count(evd_status, month_onset) %>%
  group_by(evd_status) %>%
  mutate(p = n / sum(n),
         .groups = "drop") %>%
  ggplot(aes(x = month_onset, y = 100*p, fill = evd_status)) +
  geom_col(position = position_dodge(), alpha = 0.9) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "Month of symptom onset",
       y = "%",
       subtitle = "D",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "top")
```

```{r}
patchwork::guide_area() /
  (g_pop_elig_sex + g_pop_elig_age) /
  g_pop_elig_hz /
  g_pop_elig_month +
  plot_layout(heights = c(1, 5, 5, 5), guides = "collect")
```


## EVD exposure

Exposure definitions:

1. Reported contact with EVD case.
2. Any reported exposure (any of `contact_evd_case`, `contact_hf`, `contact_tradi` and `contact_funeral`)
3. Any confirmed or probable cases in resident health area (adm3) in the last 21 days.
4. Any confirmed or probable cases in resident health zone (adm2) in the last 21 days.

### Table
```{r}
t_eligible_exp <- etc_elig_raw %>%
  mutate(
    ctr_known = ifelse(is.na(ctr_known), "Unknown", ctr_known),
    ctr_known = factor(
      ctr_known,
      c("Yes", "No", "Unknown"),
      ordered = TRUE
    ),
    ctr_followed = ifelse(is.na(ctr_followed), "Unknown", ctr_followed),
    ctr_followed = factor(
      ctr_followed,
      c("Yes", "No", "Unknown"),
      ordered = TRUE
    )
  ) %>%
  select(
    evd_status,
    `Contact with EVD case` = contact_evd_case,
    `Any reported exposure` = contact_any,
    `Cases in health area` = any_adm3,
    `Cases in health zone` = any_adm2,
    `Contact tracing, known` = ctr_known,
    `Contact tracing, followed` = ctr_followed,
    ) %>%
  tbl_summary(
    by = evd_status,
    type = list(
      `Contact with EVD case` ~ "categorical",
      `Any reported exposure` ~ "categorical",
      `Cases in health area` ~ "categorical",
      `Cases in health zone` ~ "categorical"),
    missing_text = "(Missing)")
t_eligible_exp

# Save table
gt::gtsave(as_gt(t_eligible_exp), file = here("outputs", "tables", "tb_evdexposure_alleligible.docx"))
```


## Focus: Vaccinated cases

Focus on cases who were vaccinated at least 10 days before symptom onset 

```{r}
breakthrough_evd <- etc_elig_raw %>%
  filter(
    evd_status == "EVD-pos",
    vacc_status %in% c("Unvaccinated", "Vaccinated (10+ days)"),
  ) %>%
  mutate(
    vacc_status = factor(vacc_status, c("Vaccinated (10+ days)", "Unvaccinated"), ordered = TRUE),
    month_vacc = lubridate::floor_date(date_vacc, unit = "month"),
    month_vacc = format.Date(month_vacc, format = "%Y-%m"),
    month_res_vacc = paste0(month_vacc, "_", adm2_name__res),
    month_admission = lubridate::floor_date(date_admission_eff, unit = "month"),
    month_admission = format.Date(month_admission, format = "%Y-%m"),
    month_etc_admission = paste0(month_admission, "_", etc)
    )

# Basic demographics (delay 10+ days)
breakthrough_evd %>%
  filter(delay_vacc_onset >= 10) %>%
  select(
    Sex = sex,
    `Age (years)` = age_gp,
    `Health zone` = adm2_name__res,
    `Month symptom onset` = month_onset,
    ) %>%
  tbl_summary(missing_text = "(Missing)")

# Admission (delay 10+ days)
breakthrough_evd %>%
  filter(delay_vacc_onset >= 10) %>%
  select(
    ETC = etc,
    `Month admission` = month_admission,
    ) %>%
  tbl_summary(missing_text = "(Missing)")
# Admission (delay 21+ days)
breakthrough_evd %>%
  filter(delay_vacc_onset >= 21) %>%
  select(
    ETC = etc,
    `Month admission` = month_admission,
    ) %>%
  tbl_summary(missing_text = "(Missing)")

# Vaccination (delay 10+ days)
breakthrough_evd %>%
  filter(delay_vacc_onset >= 10) %>%
  select(
    `Month vaccination` = month_vacc,
    `Resident health zone` = adm2_name__res
    ) %>%
  tbl_summary(missing_text = "(Missing)")
# Vaccination (delay 10+ days, Mangina)
breakthrough_evd %>%
  filter(etc == "Mangina (IMC)") %>%
  select(
    vacc_status,
    `Resident health zone` = adm2_name__res
    ) %>%
  tbl_summary(by = vacc_status, missing_text = "(Missing)") %>%
  add_p()
```

# Analysis pipeline

```{r}
# Contact with an EVD case
etc_elig_imp$mice_out_format |> 
  count(.imp, evd_status, contact_evd_case) |> 
  group_by(.imp, evd_status) |> 
  mutate(nex = sum(n[which(contact_evd_case != "Yes")])) |> 
  group_by(evd_status, contact_evd_case) |> 
  summarise(
    n_median = median(n),
    n_min = min(n), n_max = max(n),
    nex_median = median(nex),
    nex_min = min(nex), nex_max = max(nex)
  )

# Vaccination status
etc_elig_imp$mice_out_format |> 
  filter(
    contact_evd_case == "Yes"
  ) |> 
  count(.imp, evd_status, vacc_status) |> 
  group_by(.imp, evd_status) |> 
  mutate(nex = sum(n[which(!vacc_status %in% c("Unvaccinated", "Vaccinated (10+ days)"))])) |>
  group_by(evd_status, vacc_status) |> 
  summarise(
    n_median = median(n),
    n_min = min(n), n_max = max(n),
    nex_median = median(nex),
    nex_min = min(nex), nex_max = max(nex)
  )

# Contact + vaccination status
etc_elig_imp$mice_out_format |> 
  filter(
    contact_evd_case == "Yes",
    vacc_status %in% c("Unvaccinated", "Vaccinated (10+ days)")
  ) |> 
  count(.imp, evd_status, vacc_status) |> 
  group_by(evd_status, vacc_status) |> 
  summarise(
    n_median = median(n),
    n_min = min(n), n_max = max(n)
  )
## Under 5s only
etc_elig_imp$mice_out_format |> 
  filter(
    contact_evd_case == "Yes",
    vacc_status %in% c("Unvaccinated", "Vaccinated (10+ days)"),
    age_gp == "0-4"
  ) |> 
  count(.imp, evd_status) |> 
  group_by(evd_status) |> 
  summarise(
    n_median = median(n),
    n_min = min(n), n_max = max(n)
  )
```



# Primary study population

## Imputed-matched sample

-   Impute missing data
-   Reported contact with an EVD case
-   Vaccinated 10+ days before symptom onset, vs. unvaccinated

```{r}
tb_counts <- etc_10d_imp$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(.iter, evd_status) %>% 
  mutate(nevd = sum(n))
# Average characteristics
tb_median <- tb_counts %>%
  group_by(evd_status, vacc_status) %>%
  summarise(
    nevd_median = median(nevd),
    nevd_min = min(nevd),
    nevd_max = max(nevd),
    n_median = median(n),
    n_min = min(n),
    n_q1 = quantile(n, 0.25),
    n_q3 = quantile(n, 0.75),
    n_max = max(n),
    p_median = median(n / nevd),
    p_min = min(n / nevd),
    p_max = max(n / nevd),
    p_q1 = quantile(n / nevd, 0.25),
    p_q3 = quantile(n / nevd, 0.75),
    n = n(),
  ) %>%
  select(n, contains("evd"), vacc_status, contains("n_"), contains("p_")) %>%
  filter(vacc_status == "Vaccinated (10+ days)")
# Sample(s) with average characteristics
tb_counts_median <- tb_counts %>%
  ungroup() %>%
  mutate(status = paste0(evd_status, "_", vacc_status)) %>%
  select(-c(evd_status, vacc_status)) %>%
  pivot_wider(names_from = status, values_from = n) %>%
  janitor::clean_names() %>%
  filter(
    nevd == tb_median$nevd_median[1],
    evd_pos_vaccinated_10_days == tb_median$n_median[1],
    evd_neg_vaccinated_10_days == tb_median$n_median[2]
  )
iter_av <- tb_counts_median$iter[1]
```

### Table: key characteristics
```{r}
# "Typical" imputed-matched sample
t_10da1_matched <- etc_10d_imp$sample_list[[iter_av]] %>%
  mutate(
    month_onset = factor(
      month_onset,
      format(seq.Date(from = as.Date("2018-08-01"), to = as.Date("2019-11-01"), by = "month"), format = "%Y-%m"),
      ordered = TRUE
    )
  ) %>%
  select(
    evd_status,
    Sex = sex,
    `Age (years)` = age_gp,
    `Health zone` = adm2_name__res_gp,
    `Month symptom onset` = month_onset,
    `Vaccination status` = vacc_status
    ) %>%
  tbl_summary(by = evd_status, missing_text = "(Missing)")
## Save table
gt::gtsave(
  as_gt(t_10da1_matched),
  file = here("outputs", "tables", "tb_demog_10da1__imp_mat.docx")
  )
```

### Table: vaccination strategy
```{r}
etc_10d_imp$sample_list[[iter_av]] %>%
  filter(vacc) %>%
  mutate(
    date_vacc = date_onset - delay_vacc_onset,
    vacc_phase = case_when(
        !vacc ~ "Unvaccinated",
        vacc & date_vacc <= as.Date("2019-06-13") ~ "Original protocol",
        vacc & date_vacc >  as.Date("2019-06-13") ~ "Revised protocol",
        vacc & is.na(date_vacc) ~ "Vaccinated (date unknown)"
      ),
    vacc_phase = factor(
      vacc_phase,
      c("Unvaccinated", "Original protocol", "Revised protocol"),
      ordered = TRUE
    )
    ) %>%
  select(
    evd_status,
    `Vaccination status` = vacc_status,
    `Vaccination strategy` = vacc_phase
    ) %>%
  tbl_summary(by = evd_status, missing_text = "(Missing)")

# Details
etc_10d_imp$sample_df %>%
  mutate(
    date_vacc = date_onset - delay_vacc_onset,
    vacc_phase = case_when(
        !vacc ~ "Unvaccinated",
        vacc & date_vacc <= as.Date("2019-06-13") ~ "Original protocol",
        vacc & date_vacc >  as.Date("2019-06-13") ~ "Revised protocol",
        vacc & is.na(date_vacc) ~ "Vaccinated (date unknown)"
      ),
    vacc_phase = factor(
      vacc_phase,
      c("Unvaccinated", "Original protocol", "Revised protocol"),
      ordered = TRUE
    )
  ) %>%
  count(.iter, evd_status, vacc_status, vacc_phase) %>%
  group_by(.iter, evd_status) %>% 
  mutate(nevd = sum(n)) %>%
  group_by(.iter, evd_status, vacc_status) %>%
  mutate(nvacc = sum(n)) %>%
  group_by(evd_status, vacc_status, vacc_phase) %>%
  summarise(
    nevd_median = median(nevd),
    nevd_min = min(nevd),
    nevd_max = max(nevd),
    n_median = median(n),
    n_min = min(n),
    n_max = max(n),
    p_median = median(n / nvacc),
    p_min = min(n / nvacc),
    p_max = max(n / nvacc),
    n = n(),
  ) %>%
  select(n, contains("evd"), contains("vacc"), contains("n_"), contains("p_")) %>%
  filter(vacc_status == "Vaccinated (10+ days)")
```

### Figure: Variation in demographics
```{r}
# Sex
g_pop_sex <- etc_10d_imp$sample_df %>%
  filter(evd_status == "EVD-pos") %>%
  filter(!is.na(sex)) %>%
  count(.iter, sex) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(sex) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  ggplot(aes(x = sex)) +
  geom_col(aes(y = 100*p_med), fill = "grey50") +
  geom_errorbar(aes(y = 100*p_med, ymin = 100*p_min, ymax = 100*p_max), width = 0.2) +
  labs(x = "Sex",
       y = "%",
       subtitle = "A",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "none")

# Age group
g_pop_age <- etc_10d_imp$sample_df %>%
  filter(evd_status == "EVD-pos") %>%
  filter(!is.na(age_gp)) %>%
  count(.iter, age_gp) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(age_gp) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  ggplot(aes(x = age_gp)) +
  geom_col(aes(y = 100*p_med), fill = "grey50") +
  geom_errorbar(aes(y = 100*p_med, ymin = 100*p_min, ymax = 100*p_max), width = 0.2) +
  labs(x = "Age group (years)",
       y = "%",
       subtitle = "B",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "none")

# Health zone
g_pop_hz <- etc_10d_imp$sample_df %>%
  filter(evd_status == "EVD-pos") %>%
  count(.iter, adm2_name__res_gp) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(adm2_name__res_gp) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  ggplot(aes(x = adm2_name__res_gp)) +
  geom_col(aes(y = 100*p_med), fill = "grey50") +
  geom_errorbar(aes(y = 100*p_med, ymin = 100*p_min, ymax = 100*p_max), width = 0.2) +
  labs(x = "Health zone",
       y = "%",
       subtitle = "C",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "none")

# Month of symptom onset
g_pop_month <- etc_10d_imp$sample_df %>%
  mutate(
    month_onset = factor(
      month_onset,
      format(seq.Date(from = as.Date("2018-08-01"), to = as.Date("2019-11-01"), by = "month"), format = "%Y-%m"),
      ordered = TRUE
    )
  ) %>%
  filter(evd_status == "EVD-pos") %>%
  count(.iter, month_onset, .drop = FALSE) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(month_onset) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  ggplot(aes(x = month_onset)) +
  geom_col(aes(y = 100*p_med), fill = "grey50") +
  geom_errorbar(aes(y = 100*p_med, ymin = 100*p_min, ymax = 100*p_max), width = 0.2) +
  labs(x = "Calendar month of symptom onset",
       y = "%",
       subtitle = "D",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
(g_pop_sex + g_pop_age) /
  g_pop_hz /
  g_pop_month
```

```{r}
# Details
## under 5 years
etc_10d_imp$sample_df %>%
  filter(evd_status == "EVD-pos") %>%
  filter(!is.na(age_gp)) %>%
  count(.iter, under5 = (age_gp == "0-4")) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(under5) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  filter(under5)
## under 15 years
etc_10d_imp$sample_df %>%
  filter(evd_status == "EVD-pos") %>%
  filter(!is.na(age_gp)) %>%
  count(.iter, under15 = (age_gp %in% c("0-4", "5-14"))) %>%
  group_by(.iter) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  group_by(under15) %>%
  summarise(
    n_med = median(n),
    n_min = min(n),
    n_max = max(n),
    p_med = median(p),
    p_min = min(p),
    p_max = max(p)
  ) %>%
  filter(under15)
```

### Figure: Variation in vaccination status
```{r}
etc_10d_imp$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(.iter, evd_status) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  filter(vacc_status == "Vaccinated (10+ days)") %>%
  mutate(
    evd_status = ifelse(evd_status == "EVD-pos", "EVD-positive", "EVD-negative"),
    evd_status = factor(evd_status, c("EVD-positive", "EVD-negative"), ordered = TRUE)
    ) %>%
  ggplot(aes(x = evd_status, y = 100*p, fill = evd_status)) +
  geom_violin(col = NA, alpha = 0.5) +
  geom_boxplot(position = position_dodge(width = 0.9), width = 0.2) +
  scale_y_continuous(limits = c(0, 31)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "EVD infection status",
       y = "% vaccinated at least ten days before symptom onset",
       fill = "EVD-status") +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
etc_10d_imp$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(.iter, evd_status) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  filter(vacc_status == "Vaccinated (10+ days)") %>%
  mutate(
    evd_status = ifelse(evd_status == "EVD-pos", "Cases", "Controls"),
    evd_status = factor(evd_status, c("Cases", "Controls"), ordered = TRUE)
    ) %>%
  ggplot(aes(x = evd_status, y = 100*p, fill = evd_status)) +
  geom_violin(col = NA, alpha = 0.5) +
  geom_boxplot(position = position_dodge(width = 0.9), width = 0.2) +
  scale_y_continuous(limits = c(0, NA), breaks = seq(0, 100, 5)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = NULL,
       y = "% vaccinated") +
  theme_bw() +
  theme(legend.position = "none", text = element_text(size = 16))

etc_10d_imp$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(.iter, evd_status) %>%
  mutate(nevd = sum(n),
         p = n / nevd) %>%
  ungroup() %>%
  filter(vacc_status == "Vaccinated (10+ days)") %>%
  mutate(
    evd_status = ifelse(evd_status == "EVD-pos", "cases", "controls"),
    evd_status = factor(evd_status, c("cases", "controls"), ordered = TRUE)
  ) |> 
  select(.iter, evd_status, p) |> 
  pivot_wider(names_from = evd_status, values_from = p) |> 
  ggplot(aes(x = 100*cases, y = 100*controls)) +
  stat_density2d_filled(binwidth = 0.02) +
  geom_abline(intercept = 0, slope = 1, lty = 2, col = "lightgrey", alpha = 0.5) +
  geom_rug(sides = "b", col = RColorBrewer::brewer.pal(n = 3, "Set1")[1], alpha = 0.2) +
  geom_rug(sides = "l", col = RColorBrewer::brewer.pal(n = 3, "Set1")[2], alpha = 0.2) +
  scale_x_continuous(limits = c(0, NA)) +
  scale_y_continuous(limits = c(0, NA)) +
  scale_fill_brewer(palette = "Greys", na.value = NA) +
  labs(x = "% cases vaccinated", y = "% controls vaccinated") +
  theme_bw() +
  theme(legend.position = "none", text = element_text(size = 16))
```


# 3-9 days

```{r}
tb_counts <- etc_3d_imp$sample_df %>%
  count(.iter, evd_status, vacc_status) %>%
  group_by(.iter, evd_status) %>% 
  mutate(nevd = sum(n))
# Average characteristics
tb_median <- tb_counts %>%
  group_by(evd_status, vacc_status) %>%
  summarise(
    nevd_median = median(nevd),
    nevd_min = min(nevd),
    nevd_max = max(nevd),
    n_median = median(n),
    n_min = min(n),
    n_max = max(n),
    p_median = median(n / nevd),
    p_min = min(n / nevd),
    p_max = max(n / nevd),
    n = n(),
  ) %>%
  select(n, contains("evd"), vacc_status, contains("n_"), contains("p_")) %>%
  filter(vacc_status == "Vaccinated (10+ days)")
# Sample(s) with average characteristics
tb_counts_median <- tb_counts %>%
  ungroup() %>%
  mutate(status = paste0(evd_status, "_", vacc_status)) %>%
  select(-c(evd_status, vacc_status)) %>%
  pivot_wider(names_from = status, values_from = n) %>%
  janitor::clean_names() %>%
  filter(
    nevd == tb_median$nevd_median[1],
    evd_pos_vaccinated_10_days == tb_median$n_median[1],
    evd_neg_vaccinated_10_days == tb_median$n_median[2]
  )
iter_av <- tb_counts_median$iter[1]
```



